version: 2.1
executors:
  terraform:
    docker:
      - image: circleci/node:12.14.1
orbs:
  aws-cli: circleci/aws-cli@0.1.18
  jq: circleci/jq@1.9.1

anchors:
  configure-aws-access: &configure-aws-access
    run:
      name: Configure AWS access
      command: |
        mkdir -p ~/.aws
        file=~/.aws/credentials
        echo "[default]" > $file
        echo "aws_access_key_id = $AWS_ACCESS_KEY_ID" >> $file
        echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY" >> $file

  deploy-infra: &deploy-infra
    run:
      name: Deploy terraform platform infra
      command: |
        PATH="/home/circleci/.local/bin/:$PATH"
        source $HOME/.profile
        bash ./terraform_exec.sh 1

  destroy-infra: &destroy-infra
    run:
      name: Destroy Kuberntes Apps
      command: |
        PATH="/home/circleci/.local/bin/:$PATH"
        source $HOME/.profile
        bash ./terraform_exec.sh 2

  install-dependencies: &install-dependencies
    run:
      name: Install terraform
      command: |
        PATH="/home/circleci/.local/bin/:$PATH"
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install --user boto3 awscli
        bash ./install_terraform.sh


jobs:
  deployInfra:
    #executor: machine
    executor: terraform
    environment:
      BASH_ENV: /home/circleci/.bashrc
    steps:
      - checkout
      - *install-dependencies
      - *configure-aws-access
      - *deploy-infra

  destroyInfra:
    #executor: machine
    executor: terraform
    steps:
      - checkout
      #- *install-dependencies
      - *configure-aws-access
      - *destroy-infra

workflows:
  version: 2
  devDeploy:
    jobs:
      - deployInfra:
          context: ISENGARD-DEV
          filters:
            branches:
              only:
                - dev
                - /^eks\-.*/
                - /^XDP\-.*/
  devDestroy:
    jobs:
      - destroyInfra:
          context: ISENGARD-DEV
          filters:
            branches:
              only:
                - dev-destroy

  stageDeploy:
    jobs:
      - deployInfra:
          context: ISENGARD-STAGE
          filters:
            branches:
              only:
                - main
  stageDestroy:
    jobs:
      - destroyInfra:
          context: ISENGARD-STAGE
          filters:
            branches:
              only:
                - main-destroy

  prodDeploy:
    jobs:
      - approve-deploy:
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only:
                - /^v(\d+\.)?(\d+\.)?(\*|\d+)$/
      - deployInfra:
          context: ISENGARD-PROD
          filters:
            tags:
              only:
                - /^v(\d+\.)?(\d+\.)?(\*|\d+)$/
            branches:
              ignore: /.*/
          requires:
            - approve-deploy
